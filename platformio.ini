[platformio]
default_envs = esp32s3-qspi
src_dir = firmware/src
include_dir = firmware/include

[env]
platform = espressif32@6.7.0
framework = arduino
monitor_speed = 115200

; Default build flags
; Override DEBUG_LEVEL: pio run -b esp32s3-ospi -DDEBUG=1
build_flags =
  -DARDUINO_USB_CDC_ON_BOOT=1
  -DDEBUG=0
  ; TFT_eSPI configuration: USER_SETUP_LOADED prevents library from loading its
  ; default User_Setup.h, allowing our custom tft_setup.h to be force-included
  -DUSER_SETUP_LOADED
  -include firmware/include/tft_setup.h

; Optional: HALF_STEP support
; Uncomment to enable: pio run -b esp32s3-ospi -DHALF_STEP
; -DHALF_STEP

; All libraries with pinned versions from sketch.yaml
lib_deps =
  PU2CLR SI4735@2.1.8
  TFT_eSPI@2.5.43
  mathieucarbou/ESP Async WebServer@3.0.6
  NTPClient@3.2.1
  ESP32-targz@1.3.1
  soburi/TinyCBOR@0.5.3-arduino2

; Board settings mapped from old FQBN:
; esp32:esp32:esp32s3:CDCOnBoot=cdc,FlashSize=8M,PSRAM=opi,CPUFreq=80,USBMode=hwcdc,FlashMode=qio,PartitionScheme=custom,DebugLevel=none
board_build.partitions = firmware/partitions.csv     ; PartitionScheme=custom
board_build.flash_size = 8MB                         ; FlashSize=8M
board_build.flash_mode = qio                         ; FlashMode=qio
board_build.f_cpu = 80000000L                        ; CPUFreq=80 (80MHz)
board_build.f_flash = 80000000L                      ; Flash frequency
build_type = release                                 ; DebugLevel=none (no debug symbols)
upload_speed = 460800
upload_flags =
  --no-stub
extra_scripts = post:${PROJECT_DIR}/tools/pio_fullflash.py

; Debugging configuration (ESP32-S3 built-in USB-JTAG)
debug_tool = esp-builtin
debug_init_break =
debug_load_cmds = preload
debug_speed = 5000
debug_server =
  $PLATFORMIO_CORE_DIR/packages/tool-openocd-esp32/bin/openocd
  -f
  $PLATFORMIO_CORE_DIR/packages/tool-openocd-esp32/share/openocd/scripts/board/esp32s3-builtin.cfg

; USB settings for CDC on boot
board_build.arduino.usb_mode = 1                     ; USBMode=hwcdc
board_build.arduino.usb_on_boot = 1                  ; CDCOnBoot=cdc

; Base environment for all ESP32-S3 builds
[env_base]
board = esp32-s3-devkitc-1
build_flags =
  ${env.build_flags}
  -DBOARD_HAS_PSRAM

; OPI PSRAM configuration (8MB)
[env_opi]
board_build.psram = opi

; QSPI PSRAM configuration (2MB, requires cache fix)
[env_qspi]
board_build.arduino.memory_type = qio_qspi
board_build.psram_type = qspi
build_flags =
  ${env_base.build_flags}
  -mfix-esp32-psram-cache-issue

; Debug configuration (symbols, no optimization)
[env_debug]
build_type = debug
upload_speed = 460800
upload_flags =
  ${env.upload_flags}
  --before=default_reset
  --after=hard_reset
debug_load_mode = manual
build_unflags = -DDEBUG=0
build_flags =
  -DDEBUG=1
  -O0
  -g3
  -ggdb

; Release builds (default)
[env:esp32s3-ospi]
extends = env_base, env_opi

[env:esp32s3-qspi]
extends = env_base, env_qspi

; Debug builds
[env:esp32s3-ospi-debug]
extends = env_base, env_opi, env_debug
build_flags =
  ${env_base.build_flags}
  ${env_debug.build_flags}

[env:esp32s3-qspi-debug]
extends = env_base, env_qspi, env_debug
build_flags =
  ${env_qspi.build_flags}
  ${env_debug.build_flags}
